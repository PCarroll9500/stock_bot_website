<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock Bot Website</title>
  <style>
    :root { --bg:#0b1020; --card:#121832; --text:#e9ecf1; --muted:#9aa3b2; --accent:#6ae2a0; --warn:#ffb86c; --err:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header,footer{background:#0e1430;padding:1rem 1.25rem}
    header{font-weight:700;display:flex;gap:.6rem;align-items:center}
    main{padding:1.25rem;display:grid;gap:1rem;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.25);padding:1rem 1.25rem}
    .row{display:flex;flex-wrap:wrap;gap:1rem;align-items:center}
    .meta{display:grid;gap:.25rem;color:var(--muted);font-size:.95rem}
    .ticker{font-size:1.6rem;font-weight:700;color:var(--text)}
    .status{font-size:.95rem}
    .status.ok{color:var(--accent)}
    .status.warn{color:var(--warn)}
    .status.err{color:var(--err)}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:.55rem .9rem;font-weight:600}
    .btn.primary{background:var(--accent);color:#0b1220}
    .btn.ghost{background:transparent;border:1px solid #2a355f;color:#c9d3e7}
    svg{width:100%;height:220px}
    table{width:100%;border-collapse:collapse;border-spacing:0;margin-top:.5rem}
    th,td{padding:.55rem .6rem;text-align:right;border-bottom:1px solid #2a355f}
    th:first-child, td:first-child{text-align:left}
    th{color:#b9c2d8;font-weight:600}
    tr:hover td{background:#0f1633}
    footer{color:#8f99b3;font-size:.9rem;text-align:center}
    code.small{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.9rem;color:#bcd}
    .hidden{display:none}
    .notice{background:#1a2248;border:1px dashed #44509a;color:#cfd6ff;border-radius:10px;padding:.6rem .75rem}
  </style>
</head>
<body>
  <header>üìà Stock Bot Dashboard</header>

  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="meta">
          <div class="ticker" id="ticker">‚Äî</div>
          <div>Last Updated: <span id="lastUpdate">‚Äî</span></div>
          <div class="status" id="status">Loading‚Ä¶</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="showRawBtn">Show raw JSON</button>
          <button class="btn primary" id="retryBtn">Retry</button>
        </div>
      </div>

      <!-- Local file mode notice + picker -->
      <div id="localNotice" class="notice hidden" style="margin-top:.75rem">
        You opened this page as a local file (<code class="small">file://</code>), so browsers block <code class="small">fetch()</code>.
        Either run a small local server (e.g. <code class="small">python -m http.server</code> in <code class="small">docs/</code>)
        <em>or</em> click ‚ÄúLoad JSON‚Ä¶‚Äù to pick <code class="small">docs/data/stockinfo.json</code> manually.
        <div class="row" style="margin-top:.5rem">
          <input type="file" id="fileInput" accept=".json,application/json" class="hidden"/>
          <button class="btn primary" id="pickBtn">Load JSON‚Ä¶</button>
        </div>
      </div>

      <!-- Chart -->
      <div id="chartWrap" style="margin-top:.75rem">
        <svg id="chart" viewBox="0 0 800 220" preserveAspectRatio="none" aria-label="closing price sparkline"></svg>
      </div>

      <!-- Table -->
      <div style="overflow:auto;margin-top:.5rem">
        <table id="table">
          <thead><tr><th>Date</th><th>Close</th></tr></thead>
          <tbody id="tbody"><tr><td colspan="2">Loading‚Ä¶</td></tr></tbody>
        </table>
      </div>

      <!-- Raw JSON (toggle) -->
      <pre id="raw" class="hidden" style="margin-top:1rem;background:#0e1430;border:1px solid #2a355f;border-radius:10px;padding:.75rem;overflow:auto;max-height:300px"></pre>

      <!-- Error box -->
      <div id="errorBox" class="hidden" style="margin-top:1rem;padding:.75rem;border-radius:10px;border:1px solid #5d2a33;background:#2a1216;color:#ffd7db">
        <strong>Couldn‚Äôt load data.</strong>
        <div id="errorMsg" style="margin-top:.25rem"></div>
        <details style="margin-top:.25rem"><summary>Troubleshooting</summary>
          <ul>
            <li>For GitHub Pages / servers: ensure <code class="small">docs/data/stockinfo.json</code> exists in the deployed site.</li>
            <li>Because <code class="small">index.html</code> is in <code class="small">docs/</code>, the fetch path is <code class="small">./data/stockinfo.json</code>.</li>
            <li>We add <code class="small">?v=timestamp</code> to beat caching.</li>
            <li>For local <code class="small">file://</code>: use the ‚ÄúLoad JSON‚Ä¶‚Äù button or run a tiny server.</li>
          </ul>
        </details>
      </div>
    </section>
  </main>

  <footer>&copy; <span id="year"></span> Stock Bot</footer>

  <script>
    // ---------- CONFIG ----------
    const DATA_PATH = './data/stockinfo.json';
    const CACHE_BUST = () => `?v=${Date.now()}`;

    // ---------- ELEMENTS ----------
    const el = {
      year: document.getElementById('year'),
      ticker: document.getElementById('ticker'),
      lastUpdate: document.getElementById('lastUpdate'),
      status: document.getElementById('status'),
      tbody: document.getElementById('tbody'),
      raw: document.getElementById('raw'),
      showRawBtn: document.getElementById('showRawBtn'),
      retryBtn: document.getElementById('retryBtn'),
      chart: document.getElementById('chart'),
      chartWrap: document.getElementById('chartWrap'),
      errorBox: document.getElementById('errorBox'),
      errorMsg: document.getElementById('errorMsg'),
      localNotice: document.getElementById('localNotice'),
      pickBtn: document.getElementById('pickBtn'),
      fileInput: document.getElementById('fileInput')
    };
    el.year.textContent = new Date().getFullYear();

    // ---------- HELPERS ----------
    function setStatus(text, cls='') {
      el.status.className = `status ${cls}`;
      el.status.textContent = text;
    }
    function showError(err) {
      console.error(err);
      el.errorMsg.textContent = (err && err.message) ? err.message : String(err);
      el.errorBox.classList.remove('hidden');
      setStatus('Error loading data', 'err');
    }
    function hideError() {
      el.errorBox.classList.add('hidden');
      el.errorMsg.textContent = '';
    }
    function fmtNumber(n) {
      return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function fmtDate(iso) {
      const d = (iso && iso.length <= 10) ? new Date(iso + 'T00:00:00') : new Date(iso);
      return isNaN(d) ? String(iso) : d.toLocaleDateString();
    }
    function drawChart(series) {
      const svg = el.chart;
      while (svg.firstChild) svg.removeChild(svg.firstChild);
      if (!Array.isArray(series) || series.length < 2) { el.chartWrap.style.display = 'none'; return; }
      el.chartWrap.style.display = '';
      const W = 800, H = 220, PAD = 18;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      const ys = series.map(p => Number(p.close)).filter(v => !Number.isNaN(v));
      const xMax = series.length - 1;
      const yMin = Math.min(...ys), yMax = Math.max(...ys);
      const xScale = i => PAD + i * (W - 2*PAD) / (xMax || 1);
      const yScale = v => H - PAD - (v - yMin) * (H - 2*PAD) / ((yMax - yMin) || 1);
      // gridline last
      const last = ys[ys.length - 1];
      const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      grid.setAttribute('x1', PAD); grid.setAttribute('x2', W - PAD);
      grid.setAttribute('y1', yScale(last)); grid.setAttribute('y2', yScale(last));
      grid.setAttribute('stroke', '#2a355f'); grid.setAttribute('stroke-dasharray', '4 4');
      svg.appendChild(grid);
      // path
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      let d = '';
      series.forEach((p, i) => { const x = xScale(i), y = yScale(Number(p.close)); d += (i ? ` L ${x} ${y}` : `M ${x} ${y}`); });
      path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','#6ae2a0'); path.setAttribute('stroke-width','2.5');
      svg.appendChild(path);
      // last dot
      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      dot.setAttribute('cx', xScale(xMax)); dot.setAttribute('cy', yScale(last)); dot.setAttribute('r', 4.5); dot.setAttribute('fill','#6ae2a0');
      svg.appendChild(dot);
      // min/max labels
      const lbls = [{x:PAD,y:H-4,t:fmtNumber(yMin)},{x:W-PAD,y:H-4,t:fmtNumber(yMax)}];
      lbls.forEach(l => { const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',l.x); t.setAttribute('y',l.y); t.setAttribute('fill','#9aa3b2'); t.setAttribute('font-size','11');
        t.setAttribute('text-anchor', l.x < W/2 ? 'start':'end'); t.textContent=l.t; svg.appendChild(t);
      });
    }
    function renderTable(series) {
      const tb = el.tbody; tb.innerHTML = '';
      if (!Array.isArray(series) || series.length === 0) { tb.innerHTML = '<tr><td colspan="2">No data points.</td></tr>'; return; }
      series.slice(-30).forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmtDate(p.date)}</td><td>${fmtNumber(p.close)}</td>`;
        tb.appendChild(tr);
      });
    }
    function validatePayload(data) {
      if (!data || typeof data !== 'object') throw new Error('Invalid JSON payload.');
      if (!('ticker' in data)) throw new Error('Missing "ticker" field.');
      if (!('series' in data)) throw new Error('Missing "series" field.');
      if (!Array.isArray(data.series)) throw new Error('"series" must be an array.');
      return data;
    }
    function renderAll(payload) {
      el.ticker.textContent = payload.ticker || '‚Äî';
      el.lastUpdate.textContent = payload.updated_at ? new Date(payload.updated_at).toLocaleString() : '‚Äî';
      renderTable(payload.series);
      drawChart(payload.series);
      el.raw.textContent = JSON.stringify(payload, null, 2);
      const n = payload.series?.length || 0;
      setStatus(n ? `Loaded ${n} data point${n===1?'':'s'}` : 'Loaded (no data points)', n ? 'ok' : 'warn');
    }

    // ---------- LOAD (server mode) ----------
    async function loadFromServer() {
      hideError();
      setStatus('Loading‚Ä¶');
      el.tbody.innerHTML = '<tr><td colspan="2">Loading‚Ä¶</td></tr>';
      try {
        const resp = await fetch(DATA_PATH + CACHE_BUST(), { cache: 'no-store' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status} while fetching ${DATA_PATH}`);
        const data = await resp.json();
        renderAll(validatePayload(data));
      } catch (e) {
        showError(e);
      }
    }

    // ---------- LOAD (local file picker) ----------
    function enableLocalFileMode() {
      el.localNotice.classList.remove('hidden');
      el.pickBtn.addEventListener('click', () => el.fileInput.click());
      el.fileInput.addEventListener('change', async () => {
        const f = el.fileInput.files?.[0];
        if (!f) return;
        try {
          const text = await f.text();
          const json = JSON.parse(text);
          renderAll(validatePayload(json));
          hideError();
          setStatus('Loaded from local file', 'ok');
        } catch (e) {
          showError(e);
        }
      });
    }

    // ---------- EVENTS ----------
    el.retryBtn.addEventListener('click', () => {
      if (location.protocol === 'file:') {
        // In file mode, retry just re-prompts for file
        el.fileInput.value = '';
        el.fileInput.click();
      } else {
        loadFromServer();
      }
    });
    el.showRawBtn.addEventListener('click', () => {
      el.raw.classList.toggle('hidden');
      el.showRawBtn.textContent = el.raw.classList.contains('hidden') ? 'Show raw JSON' : 'Hide raw JSON';
    });

    // ---------- BOOT ----------
    (function init() {
      if (location.protocol === 'file:') {
        // Local file mode: show helper and allow manual load
        setStatus('Waiting for local JSON‚Ä¶', 'warn');
        enableLocalFileMode();
      } else {
        // Server/Pages mode: just fetch it
        loadFromServer();
      }
    })();
  </script>
</body>
</html>
